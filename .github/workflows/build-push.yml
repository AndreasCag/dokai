name: Build and push Docker images
on: [push]
jobs:

  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Nvidia default runtime
        run: |
          sudo add-apt-repository -y ppa:graphics-drivers
          distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
          curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
          curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | \
            sudo tee /etc/apt/sources.list.d/nvidia-docker.list
          sudo apt-get update
          sudo apt-get install -y nvidia-driver-450
          sudo apt-get install -y nvidia-container-toolkit
          sudo systemctl restart docker
      - name: Build Docker images
        run: |
          docker build -f ./docker/Dockerfile.base -t dockai:base .
          docker build -f ./docker/Dockerfile.pytorch -t dockai:pytorch .
          docker build -f ./docker/Dockerfile.tensor-stream -t dockai:tensor-stream .
          docker run --gpus=all --name=tensor-stream dockai:tensor-stream ./install_tensor_stream.sh
          docker commit tensor-stream dockai:tensor-stream
